<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Reportes de Carteles - Puerto Madryn</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- ANTES: <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.css" /> -->
    <!-- AHORA (CORREGIDO): -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- =================================== -->
    <!-- ===== INICIO: ETIQUETAS PWA ===== -->
    <!-- =================================== -->
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#2563eb"> <!-- Debe coincidir con theme_color en manifest.json -->
    <link rel="apple-touch-icon" href="./icons/icon-192.png"> <!-- Icono para iOS -->
    <!-- Opcional: Más meta tags para PWA -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Reportes Madryn">
    <meta name="application-name" content="Reportes Madryn">
    <!-- ================================= -->
    <!-- ===== FIN: ETIQUETAS PWA ====== -->
    <!-- ================================= -->

    <style>
    #map, #userMap {
        height: 610px;
        width: 100%;
        z-index: 1;
    }
    .crosshair-cursor {
        cursor: crosshair;
    }
    .tab-content {
        display: none;
    }
    .tab-content.active {
        display: block;
    }
    .custom-map-marker div {
        border-radius: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
        border: 2px solid white;
        box-shadow: 0 0 3px rgba(0,0,0,0.7);
    }

    .status-badge {
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
    }

    .info.legend-control {
        padding: 8px 12px;
        background-color: white;
        box-shadow: 0 1px 5px rgba(0,0,0,0.4);
        border-radius: 5px;
        font-size: 0.875rem;
    }
    .info.legend-control h4 {
        margin-top: 0;
        margin-bottom: 8px;
        font-weight: bold;
        font-size: 1rem;
    }
    .info.legend-control ul {
        list-style: none;
        padding: 0;
        margin: 0;
    }
    .info.legend-control li {
        margin-bottom: 4px;
        display: flex;
        align-items: center;
    }
    .info.legend-control i {
        width: 18px;
        height: 18px;
        margin-right: 8px;
        opacity: 0.9;
        border-radius: 4px;
        display: inline-block;
    }

    .marker-cluster {
        background-clip: padding-box;
        border-radius: 20px;
    }
    .marker-cluster div {
        width: 30px;
        height: 30px;
        margin-left: 5px;
        margin-top: 5px;
        text-align: center;
        border-radius: 15px;
        font: bold 12px "Helvetica Neue", Arial, Helvetica, sans-serif;
    }
    .marker-cluster span {
        line-height: 30px;
    }
    .marker-cluster-custom-small { background-color: rgba(16, 185, 129, 0.7); }
    .marker-cluster-custom-medium { background-color: rgba(6, 182, 212, 0.7); }
    .marker-cluster-custom-large { background-color: rgba(139, 92, 246, 0.7); }

    /* Estilos para el tema oscuro */
    .dark-mode {
        background-color: #1a202c;
        color: #e2e8f0;
    }
    .dark-mode .bg-white {
        background-color: #2d3748;
    }
    .dark-mode .bg-gray-100 {
        background-color: #2d3748;
    }
    .dark-mode .bg-blue-50 {
        background-color: #2c5282;
    }
    .dark-mode .bg-green-50 {
        background-color: #276749;
    }
    .dark-mode .text-gray-700 {
        color: #e2e8f0;
    }
    .dark-mode .text-gray-500 {
        color: #a0aec0;
    }
    .dark-mode .border-gray-200 {
        border-color: #4a5568;
    }
    .dark-mode .shadow-md {
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2), 0 2px 4px -1px rgba(0, 0, 0, 0.12);
    }
    .dark-mode .info.legend-control {
        background-color: #2d3748;
        color: #e2e8f0;
    }
    
    /* Corrección 1: Mejor contraste en filtros en tema oscuro */
    .dark-mode .bg-gray-50 {
        background-color: #2d3748;
    }
    .dark-mode .bg-gray-50 label {
        color: #e2e8f0 !important;
    }
    .dark-mode .bg-gray-50 select,
    .dark-mode .bg-gray-50 input {
        background-color: #4a5568;
        color: #f7fafc;
        border-color: #4a5568;
    }
    
    /* Corrección 2: Cartel de instrucciones en tema oscuro */
    .dark-mode .instructions-panel {
        background-color: #2d3748 !important;
        color: #e2e8f0 !important;
    }
    .dark-mode .instructions-panel h3 {
        color: #63b3ed !important;
    }
    .dark-mode .instructions-panel ol {
        color: #cbd5e0 !important;
    }
    /* === INICIO: ESTILOS DARK MODE ADICIONALES Y CORRECCIONES === */

    /* --- FORMULARIO DE REPORTE (Pestaña "Reporte de Incidentes") --- */
    body.dark-mode #reportFormContainer label.text-gray-700 {
        color: #d1d5db; 
    }
    body.dark-mode #reportFormContainer input[type="text"],
    body.dark-mode #reportFormContainer select,
    body.dark-mode #reportFormContainer textarea {
        background-color: #374151; 
        color: #f3f4f6;          
        border-color: #4b5563;   
    }
    body.dark-mode #reportFormContainer input[type="text"]::placeholder,
    body.dark-mode #reportFormContainer textarea::placeholder {
        color: #9ca3af; 
    }
    body.dark-mode #reportFormContainer select option {
        background-color: #374151;
        color: #f3f4f6;
    }
    body.dark-mode #reportFormContainer .border-dashed.border-gray-300 {
         border-color: #6b7280; 
    }
    body.dark-mode #reportFormContainer #openCameraBtn.bg-blue-100 {
        background-color: #1e3a8a; 
        color: #dbeafe;          
    }
    body.dark-mode #reportFormContainer #openCameraBtn.hover\:bg-blue-200:hover {
        background-color: #1c3274; 
    }
    body.dark-mode #reportFormContainer #cancelReportBtn.text-gray-700 {
        background-color: #4b5563; 
        color: #d1d5db;          
    }
    body.dark-mode #reportFormContainer #cancelReportBtn.hover\:bg-gray-100:hover {
        background-color: #6b7280; 
    }
    body.dark-mode #reportFormContainer #submitReportBtn.bg-blue-600 {
        background-color: #2563eb; 
    }
    body.dark-mode #reportFormContainer #submitReportBtn.hover\:bg-blue-700:hover {
        background-color: #1d4ed8; 
    }

    /* --- FILTROS Y ELEMENTOS DE TABLA (Pestaña "Gestión de Reportes") --- */
    /* (Algunos de estos ya los tenías, asegúrate de no duplicar si son idénticos) */
    body.dark-mode div > div > div.bg-gray-50 label.text-gray-700 { 
         color: #d1d5db !important; 
    }
    body.dark-mode div > div > div.bg-gray-50 select,
    body.dark-mode div > div > div.bg-gray-50 input[type="date"] {
        background-color: #374151; 
        color: #f3f4f6;
        border-color: #4b5563; 
    }
    body.dark-mode div > div > div.bg-gray-50 select option {
        background-color: #374151;
        color: #f3f4f6;
    }
    body.dark-mode #resetFiltersBtn.bg-gray-200 {
        background-color: #4b5563; 
        color: #e5e7eb;          
    }
    body.dark-mode #resetFiltersBtn.hover\:bg-gray-300:hover {
        background-color: #6b7280; 
    }
    body.dark-mode div.flex.items-center > span.text-sm.text-gray-600 {
        color: #9ca3af; 
    }
    body.dark-mode #rowsPerPage.border.rounded {
        background-color: #374151; 
        color: #f3f4f6;
        border-color: #4b5563; 
    }
    body.dark-mode #rowsPerPage option {
        background-color: #374151;
        color: #f3f4f6;
    }

    /* --- BOTÓN DE CAMBIO DE TEMA (Header) --- */
    #themeToggle {
        background-color: #e5e7eb; 
        border-radius: 9999px;     
        width: 40px;               
        height: 40px;              
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out;
    }
    #themeToggle:hover {
        background-color: #d1d5db; 
    }
    #themeToggle #themeIcon { 
        color: #374151;      
        transition: color 0.2s ease-in-out; 
    }
    body.dark-mode #themeToggle {
        background-color: #374151; 
    }
    body.dark-mode #themeToggle:hover {
        background-color: #4b5563; 
    }
    body.dark-mode #themeToggle #themeIcon.fa-sun {
        color: #facc15; /* Amarillo para el sol */
    }
    body.dark-mode #themeToggle #themeIcon.fa-moon { /* Para el estado inicial si carga en oscuro */
        color: #e5e7eb; /* Blanco/gris claro para la luna */
    }
    /* === FIN: ESTILOS DARK MODE ADICIONALES Y CORRECCIONES === */

    /* Evitar truncado en la cabecera del modal */
    #reportModal .modal-header {
        min-width: 300px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }   

</style>
</head>
<body class="bg-gray-100">
    <!-- Resto del código HTML se mantiene igual hasta la sección del cartel de instrucciones -->
    <div class="container mx-auto px-4 py-6">
        <header class="bg-blue-600 text-white rounded-lg shadow-md p-6 mb-6">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold">Sistema de Reportes de Carteles Nomencladores</h1>
                    <p class="mt-2">Municipalidad de Puerto Madryn, Chubut</p>
                </div>
                <img src="img/escudo_madryn.png" alt="Escudo Municipalidad de Puerto Madryn" class="h-16">
            </div>
        </header>

        <div class="bg-white rounded-lg shadow-md mb-6">
            <div class="flex border-b justify-between items-center">
                <div class="flex">
                    <button id="managementTab" class="tab-button px-6 py-3 font-medium text-gray-700 border-b-2 border-blue-500 bg-blue-50">Gestión de Reportes</button>
                    <button id="userTab" class="tab-button px-6 py-3 font-medium text-gray-500 hover:text-gray-700">Reporte de Incidentes</button>
                </div>
                <!-- En tu <header> o donde esté el botón -->
                <button id="themeToggle" title="Cambiar tema" class="p-0 focus:outline-none mr-2"> <!-- Clases de Tailwind para padding y fondo eliminadas, solo focus -->
                    <i id="themeIcon" class="fas fa-moon text-xl"></i> <!-- Solo icono base y tamaño 'text-xl' -->
                </button>
            </div>

            <!-- Management Dashboard -->
            <div id="managementContent" class="tab-content active p-6">
                 <div class="flex flex-col lg:flex-row gap-6">
                    <div class="lg:w-2/3"> <!-- Columna Izquierda - Mapa -->
                        <h2 class="text-xl font-semibold mb-4">Mapa de Incidentes</h2>
                        <div id="map"></div> <!-- Altura definida en CSS global -->
                        <!-- NOTA: La leyenda antigua ha sido eliminada de aquí -->
                    </div> <!-- FIN Columna Izquierda - Mapa -->

                    <div class="lg:w-1/3"> <!-- Columna Derecha - Estadísticas y Filtros -->
                        <div class="mb-6">
                            <h2 class="text-xl font-semibold mb-4">Estadísticas</h2>
                            <div class="grid grid-cols-2 gap-4">
                                <div class="bg-blue-100 p-4 rounded-lg">
                                    <div class="text-blue-800 font-bold text-2xl" id="todayReports">0</div>
                                    <div class="text-blue-600">Reportes hoy</div>
                                </div>
                                <div class="bg-green-100 p-4 rounded-lg">
                                    <div class="text-green-800 font-bold text-2xl" id="monthReports">0</div>
                                    <div class="text-green-600">Este mes</div>
                                </div>
                                <div class="bg-yellow-100 p-4 rounded-lg">
                                    <div class="text-yellow-800 font-bold text-2xl" id="solvedPercentage">0%</div>
                                    <div class="text-yellow-600">Resueltos</div>
                                </div>                                
                                <div class="bg-red-100 p-4 rounded-lg">
                                    <div class="text-red-800 font-bold text-2xl" id="urgentReports">0</div>
                                    <div class="text-red-600">Urgentes</div>
                                </div>                                
                            </div>
                        </div>

                        <div>
                            <h2 class="text-xl font-semibold mb-4">Filtros</h2>
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <div class="mb-3">
                                    <!-- CAMBIO: ID y 'for' actualizados para el filtro de categoría -->
                                    <label for="filtroCategoria" class="block text-gray-700 mb-1">Categoría</label>
                                    <select id="filtroCategoria" name="categoriaFiltro" class="w-full p-2 border rounded">
                                        <option value="Todos" selected>Todas</option>
                                        <option value="A realizar">A realizar</option>
                                        <option value="Nuevo">Nuevo</option>
                                        <option value="Dañado">Dañado</option>
                                        <option value="Otro">Otro</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="block text-gray-700 mb-1">Estado</label>
                                    <!-- NOTA: Los 'value' de los estados deben coincidir con los usados en Firestore y JS (ej. "Iniciado") -->
                                    <select id="filterStatus" class="w-full p-2 border rounded">
                                        <option value="Todos" selected>Todos</option> <!-- CAMBIO: 'all' por 'Todos' para consistencia con Categoría -->
                                        <option value="Iniciado">Iniciado</option> <!-- CAMBIO: "Nuevo" por "Iniciado" -->
                                        <option value="En proceso">En proceso</option>
                                        <option value="Solucionado">Solucionado</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="block text-gray-700 mb-1">Fecha</label>
                                    <input type="date" id="filterDate" class="w-full p-2 border rounded">
                                </div>
                                <button id="applyFiltersBtn" class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700">Aplicar Filtros</button>
                                <button id="resetFiltersBtn" class="w-full mt-2 bg-gray-200 text-gray-700 py-2 rounded hover:bg-gray-300">Restablecer</button>
                            </div>
                        </div>
                    </div> <!-- FIN Columna Derecha -->
                </div> <!-- FIN flex -->

                <div class="mt-8">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold">Reportes</h2>
                        <div class="flex items-center">
                            <span class="text-sm text-gray-600 mr-2">Mostrar:</span>
                            <select id="rowsPerPage" class="p-1 border rounded text-sm">
                                <option value="5">5</option>
                                <option value="10" selected>10</option>
                                <option value="20">20</option>
                                <option value="50">50</option>
                            </select>
                        </div>
                    </div>
                    <div class="bg-white rounded-lg shadow overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full min-w-max table-auto divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <!-- ID: Ampliado -->
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer sortable w-64 whitespace-nowrap">
                                        ID <i class="fas fa-sort ml-1"></i>
                                    </th>

                                    <!-- Categoría: Sin cambios -->
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer sortable w-32 whitespace-nowrap">
                                        Categoría <i class="fas fa-sort ml-1"></i>
                                    </th>

                                    <!-- Título: Sin cambios -->
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer sortable" data-column="calle1"> <!-- CAMBIADO -->
                                        Calles / Ubicación <i class="fas fa-sort ml-1"></i> <!-- CAMBIADO -->
                                    </th>

                                    <!-- Fecha: Sin cambios -->
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer sortable whitespace-nowrap">
                                        Fecha <i class="fas fa-sort ml-1"></i>
                                    </th>

                                    <!-- Estado: Sin cambios -->
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer sortable whitespace-nowrap">
                                        Estado <i class="fas fa-sort ml-1"></i>
                                    </th>

                                    <!-- Últ. Modif.: Acortado -->
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer sortable w-32 whitespace-nowrap">
                                        Últ. Modif. <i class="fas fa-sort ml-1"></i>
                                    </th>

                                    <!-- Acciones: Sin cambios -->
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap">
                                        Acciones
                                    </th>
                                </tr>
                            </thead>
                            <tbody id="reportsTableBody" class="bg-white divide-y divide-gray-200">
                                <!-- Datos dinámicos cargados aquí -->
                            </tbody>
                        </table>
                        </div>
                        <div class="bg-gray-50 px-6 py-3 flex items-center justify-between border-t border-gray-200">
                            <div class="flex-1 flex justify-between sm:hidden">
                                <button id="prevPageMobile" class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                                    Anterior
                                </button>
                                <button id="nextPageMobile" class="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                                    Siguiente
                                </button>
                            </div>
                            <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
                                <div>
                                    <p class="text-sm text-gray-700" id="paginationInfo">
                                        Mostrando <span class="font-medium">0</span> a <span class="font-medium">0</span> de <span class="font-medium">0</span> resultados
                                    </p>
                                </div>
                                <div>
                                    <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
                                        <button id="firstPage" class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                                            <span class="sr-only">Primera</span>
                                            <i class="fas fa-angle-double-left"></i>
                                        </button>
                                        <button id="prevPage" class="relative inline-flex items-center px-2 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                                            <span class="sr-only">Anterior</span>
                                            <i class="fas fa-angle-left"></i>
                                        </button>
                                        <div id="pageNumbers" class="flex">
                                            <!-- Page numbers will be added here -->
                                        </div>
                                        <button id="nextPage" class="relative inline-flex items-center px-2 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                                            <span class="sr-only">Siguiente</span>
                                            <i class="fas fa-angle-right"></i>
                                        </button>
                                        <button id="lastPage" class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                                            <span class="sr-only">Última</span>
                                            <i class="fas fa-angle-double-right"></i>
                                        </button>
                                    </nav>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div> <!-- FIN Management Dashboard -->

            <!-- User Reporting App -->
            <div id="userContent" class="tab-content p-6">
                <div class="flex flex-col lg:flex-row gap-6">
                    <div class="lg:w-2/3">
                        <h2 class="text-xl font-semibold mb-4">Reportar un incidente</h2>
                        <p class="mb-4 text-gray-300">Seleccione la ubicación exacta del incidente en el mapa haciendo clic en el lugar correspondiente.</p>
                        <div id="userMap" class="crosshair-cursor"></div> <!-- Altura definida en CSS global -->
                    </div>

                    <div class="lg:w-1/3">
                        <div class="instructions-panel bg-blue-50 p-4 rounded-lg mb-6">
                        <h3 class="font-semibold text-blue-800 mb-2">Instrucciones</h3>
                        <ol class="list-decimal list-inside text-blue-700 space-y-2">
                            <li>Busque la ubicación en el mapa</li>
                            <li>Haga clic exactamente donde ocurre el problema</li>
                            <li>Complete el formulario que aparecerá</li>
                            <li>Adjunte una foto si es posible</li>
                            <li>Enviar el reporte</li>
                        </ol>
                     </div>

                        <div id="reportFormContainer" class="hidden bg-white p-4 rounded-lg shadow">
                            <h3 class="font-semibold text-lg mb-3">Detalles del reporte</h3>
                            <form id="incidentForm">
                                <!-- ESTE ES EL BLOQUE QUE REEMPLAZAS (EL ANTIGUO CAMPO TÍTULO):
                                <div class="mb-3">
                                    <label for="reportTitle" class="block text-gray-700 mb-1">Título</label>
                                    <input type="text" id="reportTitle" class="w-full p-2 border rounded" placeholder="Ej: Cartel dañado en Av. Roca" required>
                                </div>
                                -->

                                <!-- ***** INICIO: NUEVOS CAMPOS CALLE 1 Y CALLE 2 ***** -->
                                <div class="mb-3">
                                    <label for="calle1" class="block text-gray-700 mb-1">Calle Principal (Ej: Sarmiento 800-900)</label>
                                    <input type="text" id="calle1" name="calle1" class="w-full p-2 border rounded" placeholder="Nombre de la calle y altura/tramo" required>
                                </div>
                                <div class="mb-3">
                                    <label for="calle2" class="block text-gray-700 mb-1">Calle Secundaria / Intersección (Opcional)</label>
                                    <input type="text" id="calle2" name="calle2" class="w-full p-2 border rounded" placeholder="Calle de cruce o referencia adicional">
                                    <!-- Nota: 'calle2' no tiene 'required', es opcional -->
                                </div>
                                <!-- ***** FIN: NUEVOS CAMPOS CALLE 1 Y CALLE 2 ***** -->
                                    <!-- CAMPO CATEGORÍA - ASEGÚRATE QUE ESTÉ ASÍ -->
                            <div class="mb-3"> <!-- Este div envuelve label y select de categoría -->
                                <label for="categoriaFormulario" class="block text-gray-700 mb-1">Categoría</label>
                                <select id="categoriaFormulario" name="categoriaReporteFormulario" class="w-full p-2 border rounded" required>
                                    <option value="" disabled selected>Seleccione una categoría...</option>
                                    <option value="A realizar">A realizar</option>
                                    <option value="Nuevo">Nuevo</option>
                                    <option value="Dañado">Dañado</option>
                                    <option value="Otro">Otro</option>
                                </select>
                            </div> <!-- ESTE es el cierre correcto del div de Categoría -->
                                <div class="mb-3">
                                    <label for="reportDescription" class="block text-gray-700 mb-1">Descripción</label> <!-- CAMBIO: 'for' añadido -->
                                    <textarea id="reportDescription" class="w-full p-2 border rounded" rows="3" placeholder="Describa el problema con detalle..." required></textarea>
                                </div>
                                <div class="mb-3">
                                    <label class="block text-gray-700 mb-1">Adjuntar foto (opcional)</label>
                                    <div class="border-2 border-dashed border-gray-300 rounded p-4 text-center">
                                        <div id="cameraPreview" class="hidden mb-2">
                                            <img id="previewImage" src="#" alt="Preview" class="max-w-full max-h-40 mx-auto">
                                        </div>
                                        <button type="button" id="openCameraBtn" class="bg-blue-100 text-blue-700 px-4 py-2 rounded hover:bg-blue-200">
                                            <i class="fas fa-camera mr-2"></i>Tomar/Adjuntar foto
                                        </button>
                                        <input type="file" id="fileInput" accept="image/*" class="hidden"> <!-- NOTA: Eliminado 'capture="environment"' para que funcione mejor en escritorio también -->
                                    </div>
                                </div>
                                <div class="flex justify-end gap-2">
                                    <button type="button" id="cancelReportBtn" class="px-4 py-2 border rounded text-gray-700 hover:bg-gray-100">Cancelar</button>
                                    <button type="submit" id="submitReportBtn" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Enviar reporte</button> <!-- CAMBIO: ID añadido al botón de submit -->
                                </div>
                            </form>
                        </div>

                        <div id="successMessage" class="hidden bg-green-50 p-4 rounded-lg text-green-700 mt-4"> <!-- CAMBIO: 'mt-4' añadido -->
                            <div class="flex items-center">
                                <i class="fas fa-check-circle text-green-500 text-2xl mr-2"></i>
                                <div>
                                    <h3 class="font-semibold">¡Reporte enviado con éxito!</h3>
                                    <p class="text-sm">Número de seguimiento: #<span id="reportNumber"></span></p>
                                </div>
                            </div>
                            <button id="newReportBtn" class="mt-3 w-full bg-green-600 text-white py-2 rounded hover:bg-green-700">Hacer otro reporte</button>
                        </div>
                    </div>
                </div>
            </div> <!-- FIN User Reporting App -->
        </div> <!-- FIN Contenedor de Pestañas -->
    </div> <!-- FIN Contenedor Principal -->

    <!-- Modal for report details -->
    <div id="reportModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-2/3 lg:w-1/2 shadow-lg rounded-md bg-white">
            <div class="flex justify-between items-center border-b pb-3">
                <h3 class="text-xl font-semibold" id="modalTitle">Detalles del Reporte #<span id="modalReportId"></span></h3>
                <button id="closeModal" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
                        <!-- DENTRO DE <div id="reportModal" ...> <div class="relative top-20 ..."> -->
            <!-- ... (el div del encabezado con id="modalTitle" y el botón de cierre se quedan igual) ... -->

            <div class="py-4"> <!-- Este div ya lo tienes -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4"> <!-- Añadido mb-4 para separar de la descripción -->
                    <div>
                        <h4 class="font-medium text-gray-700">Calle Principal:</h4>
                        <p id="modalCalle1" class="mt-1 text-sm"></p> <!-- text-sm para que no ocupe tanto -->
                    </div>
                    <div>
                        <h4 class="font-medium text-gray-700">Calle Secundaria/Intersección:</h4>
                        <p id="modalCalle2" class="mt-1 text-sm"></p>
                    </div>
                    <div>
                        <h4 class="font-medium text-gray-700">Categoría del Problema:</h4>
                        <p id="modalCategoria" class="mt-1 text-sm"></p>
                    </div>
                    <div>
                        <h4 class="font-medium text-gray-700">Estado:</h4>
                        <p id="modalStatus" class="mt-1 text-sm"></p>
                    </div>
                    <div>
                        <h4 class="font-medium text-gray-700">Fecha Creación:</h4>
                        <p id="modalDate" class="mt-1 text-sm"></p>
                    </div>
                    <div>
                        <h4 class="font-medium text-gray-700">Últ. Modificación:</h4>
                        <p id="modalDateModified" class="mt-1 text-sm"></p>
                    </div>
                    <div class="md:col-span-2"> <!-- Hacer que Ubicación (Lat, Lng) ocupe todo el ancho si es necesario -->
                        <h4 class="font-medium text-gray-700">Ubicación (Lat, Lng):</h4>
                        <p id="modalLocation" class="mt-1 text-sm"></p>
                    </div>
                </div>

                <div class="mt-4"> <!-- Este div ya lo tienes -->
                    <h4 class="font-medium text-gray-700">Descripción:</h4>
                    <p id="modalDescription" class="mt-1 text-sm"></p> <!-- text-sm añadido -->
                </div>

                <div class="mt-4"> <!-- Este div ya lo tienes -->
                    <h4 class="font-medium text-gray-700">Imagen:</h4>
                    <div id="modalImageContainer" class="mt-2">
                        <img id="modalImage" src="" alt="Imagen del reporte" class="max-w-full max-h-64 rounded object-contain">
                    </div>
                </div>
            </div> <!-- Cierre de <div class="py-4"> -->

            <!-- ... (el div de los botones "En proceso", "Resolver" se queda igual) ... -->
            <div class="flex justify-end pt-2 border-t">
                <button id="markInProgressBtn" class="px-4 py-2 bg-yellow-500 text-white rounded hover:bg-yellow-600 mr-2">
                    <i class="fas fa-spinner mr-1"></i> En proceso
                </button>
                <button id="markSolvedBtn" class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600">
                    <i class="fas fa-check mr-1"></i> Resolver
                </button>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

    <!-- Firebase SDK y Configuración -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
      import { getFirestore, collection, addDoc, serverTimestamp, onSnapshot, query, doc, updateDoc, getDocs, where, orderBy, limit, startAfter, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
      // CAMBIO: Importadas más funciones de Firestore para paginación y otras mejoras (si las implementamos luego)
      import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";


      const firebaseConfig = {
        apiKey: "AIzaSyAUUI_08-i6xcdjE62iL-g9QqXYR4DVD_k", // NOTA: Esta es tu clave, la mantengo
        authDomain: "puerto-madryn-carteleria.firebaseapp.com",
        projectId: "puerto-madryn-carteleria",
        storageBucket: "puerto-madryn-carteleria.appspot.com", // CAMBIO: .appspot.com es el formato común
        messagingSenderId: "718469443289",
        appId: "1:718469443289:web:2541051c0c538011d058c8"
        };

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const storage = getStorage(app); // CAMBIO: Inicialización de Storage

      // Exponer a window para scripts no-module
      window.app = app;
      window.db = db;
      window.storage = storage; // CAMBIO: Storage expuesto
      window.firebaseFirestore = { collection, addDoc, serverTimestamp, onSnapshot, query, doc, updateDoc, getDocs, where, orderBy, limit, startAfter, getDoc };
      window.firebaseStorage = { ref, uploadBytes, getDownloadURL }; // CAMBIO: Funciones de Storage expuestas

      console.log("Firebase SDK cargado y configurado via module script.");
    </script>

            <script>
        // ----- VARIABLES GLOBALES -----
        let allReports = [];
        let currentDisplayedReports = [];
        let currentPage = 1;
        const rowsPerPageOptions = [5, 10, 20, 50];
        let currentRowsPerPage = 10;
        let totalPages = 1;
        let currentSortColumn = 'fechaCreacion';
        let currentSortDirection = 'desc';
        let selectedLocation = null; // Para el marcador del NUEVO reporte en userMap
        let currentReportIdForModal = null;
        let userMapInitialized = false; // Para la inicialización diferida de controles en userMap
        
        let managementMap;
        let userMap;
        let managementMapMarkers;         // Para L.markerClusterGroup en managementMap
        let userMapExistingReportMarkers; // Para L.layerGroup de reportes existentes en userMap

        const CATEGORY_COLORS = {
            'A realizar': '#FFA500', // Naranja
            'Nuevo':    '#28A745', // Verde
            'Dañado':   '#DC3545', // Rojo
            'Otro':     '#6c757d', // Gris
            'default':  '#007bff'  // Azul por defecto
        };

        // ----- CONSTANTES DE ELEMENTOS DEL DOM (Cachear selectores) -----
        // Pestañas
        const managementTabEl = document.getElementById('managementTab');
        const userTabEl = document.getElementById('userTab');
        const managementContentEl = document.getElementById('managementContent');
        const userContentEl = document.getElementById('userContent');

        // Formulario de Reporte
        const reportFormContainerEl = document.getElementById('reportFormContainer');
        const incidentFormEl = document.getElementById('incidentForm');
        // const reportTitleInputEl = document.getElementById('reportTitle'); // Ya no se usa
        const categoriaFormularioSelectEl = document.getElementById('categoriaFormulario');
        const reportDescriptionTextareaEl = document.getElementById('reportDescription');
        const openCameraBtnEl = document.getElementById('openCameraBtn');
        const fileInputEl = document.getElementById('fileInput');
        const cameraPreviewDivEl = document.getElementById('cameraPreview');
        const previewImageEl = document.getElementById('previewImage');
        const cancelReportBtnEl = document.getElementById('cancelReportBtn');
        const submitReportBtnEl = document.getElementById('submitReportBtn');
        const successMessageDivEl = document.getElementById('successMessage');
        const reportNumberSpanEl = document.getElementById('reportNumber');
        const newReportBtnEl = document.getElementById('newReportBtn');

        // Filtros
        const filtroCategoriaSelectEl = document.getElementById('filtroCategoria');
        const filterStatusSelectEl = document.getElementById('filterStatus');
        const filterDateInputEl = document.getElementById('filterDate');
        const applyFiltersBtnEl = document.getElementById('applyFiltersBtn');
        const resetFiltersBtnEl = document.getElementById('resetFiltersBtn');

        // Tabla y Paginación
        const reportsTableBodyEl = document.getElementById('reportsTableBody');
        const rowsPerPageSelectEl = document.getElementById('rowsPerPage');
        const paginationInfoEl = document.getElementById('paginationInfo');
        const pageNumbersDivEl = document.getElementById('pageNumbers');
        const firstPageBtnEl = document.getElementById('firstPage');
        const prevPageBtnEl = document.getElementById('prevPage');
        const nextPageBtnEl = document.getElementById('nextPage');
        const lastPageBtnEl = document.getElementById('lastPage');
        const prevPageMobileBtnEl = document.getElementById('prevPageMobile');
        const nextPageMobileBtnEl = document.getElementById('nextPageMobile');

        // Modal
        const reportModalEl = document.getElementById('reportModal');
        const modalTitleEl = document.getElementById('modalTitle');
        const modalReportIdSpanEl = document.getElementById('modalReportId'); // Si decides usarlo
        const modalCategoriaPEl = document.getElementById('modalCategoria');
        const modalStatusPEl = document.getElementById('modalStatus');
        const modalDatePEl = document.getElementById('modalDate');
        const modalDateModifiedPEl = document.getElementById('modalDateModified');
        const modalLocationPEl = document.getElementById('modalLocation');
        const modalDescriptionPEl = document.getElementById('modalDescription');
        const modalImageContainerEl = document.getElementById('modalImageContainer');
        const modalImageEl = document.getElementById('modalImage');
        const modalCalle1PEl = document.getElementById('modalCalle1'); // Para el modal
        const modalCalle2PEl = document.getElementById('modalCalle2'); // Para el modal
        const closeModalBtnEl = document.getElementById('closeModal');
        const markInProgressBtnEl = document.getElementById('markInProgressBtn');
        const markSolvedBtnEl = document.getElementById('markSolvedBtn');

        // Estadísticas
        const todayReportsSpanEl = document.getElementById('todayReports');
        const monthReportsSpanEl = document.getElementById('monthReports');
        const solvedPercentageSpanEl = document.getElementById('solvedPercentage');
        const urgentReportsSpanEl = document.getElementById('urgentReports'); // Para "Dañados Pendientes"

        // Tema oscuro
        const themeToggleBtn = document.getElementById('themeToggle');
        const themeIcon = document.getElementById('themeIcon');


        // ----- INICIALIZACIÓN AL CARGAR EL DOM -----
        document.addEventListener('DOMContentLoaded', function() {
            console.log("DOM cargado. Configurando listeners e inicializando mapas...");
            setupEventListeners();
            initManagementMap();
            initUserMap();      // Inicializa userMap base y su layerGroup para marcadores existentes
            listenToReports();  // Empieza a escuchar datos de Firebase
            applyInitialTheme(); // Aplica el tema oscuro/claro inicial
        });

        // ----- CONFIGURACIÓN DE EVENT LISTENERS -----
        function setupEventListeners() {
            console.log("Configurando Event Listeners...");
            // Pestañas
            if (managementTabEl) managementTabEl.addEventListener('click', () => switchTab('management'));
            if (userTabEl) {
                userTabEl.addEventListener('click', () => {
                    switchTab('user');
                    
                    if (!userMapInitialized && userMap) {
                        console.log("userTab click: Inicializando controles de userMap (GPS, clic mapa).");
                        const GpsButtonControl = L.Control.extend({
                            options: { position: 'topright' },
                            onAdd: function (map) {
                                const container = L.DomUtil.create('div', 'leaflet-bar leaflet-control leaflet-control-custom');
                                container.style.backgroundColor = 'white'; container.style.width = '34px'; container.style.height = '34px';
                                container.style.borderRadius = '4px'; container.style.boxShadow = '0 1px 5px rgba(0,0,0,0.4)';
                                container.style.display = 'flex'; container.style.alignItems = 'center'; container.style.justifyContent = 'center';
                                container.style.cursor = 'pointer';
                                container.innerHTML = '<i class="fas fa-location-crosshairs" style="font-size: 18px; color: #333;"></i>';
                                container.title = 'Usar mi ubicación actual';
                                L.DomEvent.disableClickPropagation(container);
                                L.DomEvent.on(container, 'click', function (ev) {
                                    L.DomEvent.stopPropagation(ev);
                                    obtenerUbicacionGPSParaUserMap(); 
                                });
                                return container;
                            }
                        });
                        userMap.addControl(new GpsButtonControl());

                        userMap.on('click', function(e) {
                            if (!e.latlng) { console.error("Error: e.latlng no está definido en el evento de clic del userMap."); return; }
                            actualizarMarcadorYFormulario(e.latlng);
                        });
                        userMapInitialized = true;
                        console.log("userMap ahora completamente inicializado con controles y listeners interactivos.");
                    }

                    if (userMap && selectedLocation) {
                        userMap.removeLayer(selectedLocation);
                        selectedLocation = null;
                    }
                    if (reportFormContainerEl) reportFormContainerEl.classList.add('hidden'); 
                    if (successMessageDivEl) successMessageDivEl.classList.add('hidden');

                    if (userMapInitialized && allReports.length > 0 && userMapExistingReportMarkers) { 
                        renderUserMapExistingReports(allReports);
                    } else if (userMapInitialized && userMapExistingReportMarkers) { 
                        userMapExistingReportMarkers.clearLayers();
                    }
                });
            }

            // Filtros
            if (applyFiltersBtnEl) applyFiltersBtnEl.addEventListener('click', applyFilters);
            if (resetFiltersBtnEl) resetFiltersBtnEl.addEventListener('click', resetFilters);

            // Formulario de Reporte
            if (incidentFormEl) incidentFormEl.addEventListener('submit', handleReportSubmit);
            if (cancelReportBtnEl) cancelReportBtnEl.addEventListener('click', cancelReport);
            if (newReportBtnEl) newReportBtnEl.addEventListener('click', prepareNewReport);
            if (openCameraBtnEl) openCameraBtnEl.addEventListener('click', () => fileInputEl.click());
            if (fileInputEl) fileInputEl.addEventListener('change', handleFileSelect);

            // Tabla y Paginación
            document.querySelectorAll('.sortable').forEach(header => {
                header.addEventListener('click', () => handleSort(header.getAttribute('data-column')));
            });
            if (rowsPerPageSelectEl) rowsPerPageSelectEl.addEventListener('change', (e) => {
                currentRowsPerPage = parseInt(e.target.value);
                currentPage = 1;
                renderTable();
            });
            if (firstPageBtnEl) firstPageBtnEl.addEventListener('click', () => paginate('first'));
            if (prevPageBtnEl) prevPageBtnEl.addEventListener('click', () => paginate('prev'));
            if (nextPageBtnEl) nextPageBtnEl.addEventListener('click', () => paginate('next'));
            if (lastPageBtnEl) lastPageBtnEl.addEventListener('click', () => paginate('last'));
            if (prevPageMobileBtnEl) prevPageMobileBtnEl.addEventListener('click', () => paginate('prev'));
            if (nextPageMobileBtnEl) nextPageMobileBtnEl.addEventListener('click', () => paginate('next'));

            // Modal
            if (closeModalBtnEl) closeModalBtnEl.addEventListener('click', closeModal);
            if (markInProgressBtnEl) markInProgressBtnEl.addEventListener('click', () => updateReportStatusOnModal('En proceso'));
            if (markSolvedBtnEl) markSolvedBtnEl.addEventListener('click', () => updateReportStatusOnModal('Solucionado'));

            // Tema oscuro
            if (themeToggleBtn && themeIcon) { // Asegurarse que ambos existan
                themeToggleBtn.addEventListener('click', toggleDarkMode);
            }
            console.log("Event Listeners configurados.");
        }

        // ----- LÓGICA DE PESTAÑAS -----
        function switchTab(tabName) {
            // ... (código de switchTab que ya tienes y funciona) ...
            const isActiveManagement = tabName === 'management';
            managementTabEl.classList.toggle('border-blue-500', isActiveManagement);
            managementTabEl.classList.toggle('bg-blue-50', isActiveManagement);
            managementTabEl.classList.toggle('text-gray-500', !isActiveManagement);
            managementTabEl.classList.toggle('hover:text-gray-700', !isActiveManagement);
            managementContentEl.classList.toggle('active', isActiveManagement);

            userTabEl.classList.toggle('border-blue-500', !isActiveManagement);
            userTabEl.classList.toggle('bg-blue-50', !isActiveManagement);
            userTabEl.classList.toggle('text-gray-500', isActiveManagement);
            userTabEl.classList.toggle('hover:text-gray-700', isActiveManagement);
            userContentEl.classList.toggle('active', !isActiveManagement);

            setTimeout(() => {
                if (isActiveManagement && managementMap) managementMap.invalidateSize();
                if (!isActiveManagement && userMap) userMap.invalidateSize();
            }, 100);
        }

        // ----- LÓGICA DE TEMA OSCURO -----
        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            if (themeIcon) {
                if (document.body.classList.contains('dark-mode')) {
                    themeIcon.classList.remove('fa-moon', 'text-white');
                    themeIcon.classList.add('fa-sun', 'text-yellow-400');
                    localStorage.setItem('darkMode', 'enabled');
                } else {
                    themeIcon.classList.remove('fa-sun', 'text-yellow-400');
                    themeIcon.classList.add('fa-moon', 'text-white');
                    localStorage.setItem('darkMode', 'disabled');
                }
            }
        }

        function applyInitialTheme() {
            const savedMode = localStorage.getItem('darkMode');
            const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
            const isDarkMode = savedMode === 'enabled' || (!savedMode && prefersDark);
            if (themeIcon) { // Solo si themeIcon existe
                if (isDarkMode) {
                    document.body.classList.add('dark-mode');
                    themeIcon.classList.remove('fa-moon', 'text-white');
                    themeIcon.classList.add('fa-sun', 'text-yellow-400');
                } else {
                    document.body.classList.remove('dark-mode');
                    themeIcon.classList.remove('fa-sun', 'text-yellow-400');
                    themeIcon.classList.add('fa-moon', 'text-white');
                }
            }
            console.log("Tema inicial aplicado:", isDarkMode ? "oscuro" : "claro");
        }


        // ----- LÓGICA DE FIREBASE (LECTURA) -----
        function listenToReports() {
            console.log("0. Entrando a listenToReports");
            const { collection, query, onSnapshot, orderBy } = window.firebaseFirestore;
            if (!window.db || !collection || !query || !onSnapshot || !orderBy) {
                console.error("ERROR CRÍTICO: Funciones de Firestore no disponibles en listenToReports.");
                return;
            }
            const q = query(collection(window.db, "reclamos"), orderBy("fechaCreacion", "desc"));
            onSnapshot(q, (querySnapshot) => {
                console.log("1. onSnapshot RECIBIÓ DATOS. Cantidad de docs:", querySnapshot.size);
                if (querySnapshot.empty) {
                    allReports = [];
                } else {
                   allReports = querySnapshot.docs.map(doc => {
                    const data = doc.data();
                    return {
                        id: doc.id,
                        calle1: data.calle1 || '',
                        calle2: data.calle2 || '',
                        tipoIncidente: data.tipoIncidente || "Cartel Nomenclador",
                        categoria: data.categoria || 'Otro',
                        descripcion: data.descripcion || '',
                        fechaCreacion: data.fechaCreacion ? data.fechaCreacion.toDate() : null,
                        fechaUltimaModificacion: data.fechaUltimaModificacion ? data.fechaUltimaModificacion.toDate() : null,
                        estado: data.estado || 'Iniciado',
                        latitud: data.latitud,
                        longitud: data.longitud,
                        imagenURL: data.imagenURL || null
                    };
                });
                }
                console.log("1.2. allReports actualizado. Cantidad:", allReports.length);
                applyFilters();
                updateStatistics();
                if (userMap && userMapExistingReportMarkers) { // Llamar solo si están listos
                    renderUserMapExistingReports(allReports);
                } else {
                    console.warn("listenToReports: userMap o userMapExistingReportMarkers NO listos para renderUserMapExistingReports.");
                }
            }, (error) => {
                console.error("ERROR en onSnapshot:", error);
            });
        }

        // ----- LÓGICA DE FORMULARIO DE REPORTE -----
        async function handleReportSubmit(event) {
            // ... (código de handleReportSubmit que ya tienes y funciona) ...
            event.preventDefault();
            if (!selectedLocation) { alert('Por favor, seleccione una ubicación en el mapa.'); return; }
            if(submitReportBtnEl) submitReportBtnEl.disabled = true;

            const calle1 = document.getElementById('calle1').value.trim();
            const calle2 = document.getElementById('calle2').value.trim();
            const categoria = categoriaFormularioSelectEl.value;
            const descripcion = reportDescriptionTextareaEl.value.trim();
            const latLng = selectedLocation.getLatLng();
            const file = fileInputEl.files[0];
            let imagenURL = null;

            if (file && window.firebaseStorage && window.storage) { // Verificar que las funciones y storage existan
                try {
                    const storageRef = window.firebaseStorage.ref(window.storage, `imagenes_reportes/${Date.now()}_${file.name}`);
                    await window.firebaseStorage.uploadBytes(storageRef, file);
                    imagenURL = await window.firebaseStorage.getDownloadURL(storageRef);
                } catch (error) { console.error("Error al subir imagen:", error); alert("Error al subir imagen, reporte se enviará sin ella.");}
            }

            const nuevoReporteData = {
                calle1, calle2, tipoIncidente: "Cartel Nomenclador", categoria, descripcion,
                latitud: latLng.lat, longitud: latLng.lng, estado: "Iniciado",
                fechaCreacion: window.firebaseFirestore.serverTimestamp(),
                fechaUltimaModificacion: window.firebaseFirestore.serverTimestamp(),
                imagenURL
            };
            try {
                const { collection, addDoc } = window.firebaseFirestore;
                const docRef = await addDoc(collection(window.db, "reclamos"), nuevoReporteData);
                successMessageDivEl.classList.remove('hidden');
                reportNumberSpanEl.textContent = docRef.id.substring(0,10)+"..."; // Acortar ID
                reportFormContainerEl.classList.add('hidden');
                incidentFormEl.reset();
                previewImageEl.src = '#'; cameraPreviewDivEl.classList.add('hidden'); fileInputEl.value = null;
                if (selectedLocation) { userMap.removeLayer(selectedLocation); selectedLocation = null; }
            } catch (error) { console.error("Error al guardar reporte:", error); alert('Error al enviar reporte.');
            } finally { if(submitReportBtnEl) submitReportBtnEl.disabled = false; }
        }
        function cancelReport() { /* ... (código de cancelReport que ya tienes) ... */ 
            if (selectedLocation) { userMap.removeLayer(selectedLocation); selectedLocation = null; }
            reportFormContainerEl.classList.add('hidden'); incidentFormEl.reset();
            previewImageEl.src = '#'; cameraPreviewDivEl.classList.add('hidden'); fileInputEl.value = null;
            successMessageDivEl.classList.add('hidden');
        }
        function prepareNewReport() { /* ... (código de prepareNewReport que ya tienes) ... */
            successMessageDivEl.classList.add('hidden');
            if (selectedLocation) { userMap.removeLayer(selectedLocation); selectedLocation = null; }
            alert("Haga clic en el mapa para seleccionar la ubicación del nuevo reporte.");
        }
        function handleFileSelect(event) { /* ... (código de handleFileSelect que ya tienes) ... */
             if (event.target.files && event.target.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e_reader) {
                    previewImageEl.src = e_reader.target.result;
                    cameraPreviewDivEl.classList.remove('hidden');
                }
                reader.readAsDataURL(event.target.files[0]);
            }
        }

        // ----- LÓGICA DE FILTROS -----
        function applyFilters() {
            // ... (código de applyFilters que ya tienes y funciona) ...
            console.log("Aplicando filtros. AllReports:", allReports.length);
            const categoria = filtroCategoriaSelectEl.value;
            const estado = filterStatusSelectEl.value;
            const fecha = filterDateInputEl.value;
            currentDisplayedReports = allReports.filter(report => {
                const CategoriaPasa = (categoria === 'Todos') || (report.categoria === categoria);
                const EstadoPasa = (estado === 'Todos') || (report.estado === estado);
                let FechaPasa = true;
                if (fecha && report.fechaCreacion !== 'Fecha no disponible') {
                    const [day, month, year] = report.fechaCreacion.split('/');
                    const reportDateYYYYMMDD = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
                    FechaPasa = reportDateYYYYMMDD === fecha;
                } else if (fecha && report.fechaCreacion === 'Fecha no disponible') {
                    FechaPasa = false; // Si se filtra por fecha y el reporte no tiene, no pasa
                }
                return CategoriaPasa && EstadoPasa && FechaPasa;
            });
            console.log("Filtros aplicados. CurrentDisplayedReports:", currentDisplayedReports.length);
            currentPage = 1; renderTable(); renderMapMarkers();
        }
        function resetFilters() { /* ... (código de resetFilters que ya tienes y funciona) ... */
            filtroCategoriaSelectEl.value = 'Todos'; filterStatusSelectEl.value = 'Todos';
            filterDateInputEl.value = ''; applyFilters();
        }

        // ----- LÓGICA DE LA TABLA Y PAGINACIÓN -----
        function renderTable() {
            // ... (código de renderTable que ya tienes, asegurándote de que muestre calle1 y calle2) ...
            reportsTableBodyEl.innerHTML = '';
            currentDisplayedReports.sort((a, b) => { /* ... tu lógica de sort ... */ 
                let valA = a[currentSortColumn]; let valB = b[currentSortColumn];
                if (currentSortColumn === 'fechaCreacion' || currentSortColumn === 'fechaUltimaModificacion') {
                    valA = valA instanceof Date ? valA : new Date(0); // Asegurar que sea Date
                    valB = valB instanceof Date ? valB : new Date(0);
                }
                if (valA < valB) return currentSortDirection === 'asc' ? -1 : 1;
                if (valA > valB) return currentSortDirection === 'asc' ? 1 : -1;
                return 0;
            });
            totalPages = Math.ceil(currentDisplayedReports.length / currentRowsPerPage);
            if (totalPages === 0) totalPages = 1; if (currentPage > totalPages) currentPage = totalPages;
            const startIndex = (currentPage - 1) * currentRowsPerPage;
            const endIndex = Math.min(startIndex + currentRowsPerPage, currentDisplayedReports.length);
            const paginatedReports = currentDisplayedReports.slice(startIndex, endIndex);
            paginatedReports.forEach(report => {
                const row = reportsTableBodyEl.insertRow(); row.setAttribute('data-report-id', report.id); row.style.cursor = 'pointer';
                row.addEventListener('click', () => handleRowClick(report));
                row.insertCell().textContent = `#${report.id}`;
                row.insertCell().textContent = report.categoria || 'N/A';
                const celdaUbicacion = row.insertCell();
                let textoUbicacion = report.calle1 || 'Ubicación no especificada';
                if (report.calle2) { textoUbicacion += (report.calle1 ? ` y ${report.calle2}` : report.calle2); }
                celdaUbicacion.textContent = textoUbicacion;
                row.insertCell().textContent = report.fechaCreacion ? formatDate(report.fechaCreacion) : 'Fecha no disponible';
                const estadoCell = row.insertCell();
                estadoCell.innerHTML = `<span class="status-badge ${getStatusClass(report.estado)}">${report.estado}</span>`;
                row.insertCell().textContent = report.fechaUltimaModificacion ? formatDate(report.fechaUltimaModificacion) : '-';
                const actionsCell = row.insertCell();
                actionsCell.innerHTML = `
                    <button onclick="event.stopPropagation(); openReportModal('${report.id}')" class="text-blue-600 hover:text-blue-900 mr-2" title="Ver Detalles"><i class="fas fa-eye"></i></button>
                    ${report.estado !== 'Solucionado' ? `<button onclick="event.stopPropagation(); updateReportStatus('${report.id}', 'Solucionado')" class="text-green-600 hover:text-green-900" title="Marcar como Solucionado"><i class="fas fa-check"></i></button>` : ''}
                `;
            });
            updatePaginationControls();
        }
        function handleSort(column) { /* ... (código de handleSort que ya tienes) ... */
            if (currentSortColumn === column) { currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
            } else { currentSortColumn = column; currentSortDirection = 'asc'; }
            document.querySelectorAll('.sortable i').forEach(icon => icon.className = 'fas fa-sort ml-1');
            const activeHeaderIcon = document.querySelector(`.sortable[data-column="${column}"] i`);
            if (activeHeaderIcon) activeHeaderIcon.className = `fas fa-sort-${currentSortDirection === 'asc' ? 'up' : 'down'} ml-1`;
            renderTable();
         }
        function paginate(action) { /* ... (código de paginate que ya tienes) ... */
            switch (action) {
                case 'first': currentPage = 1; break; case 'prev': if (currentPage > 1) currentPage--; break;
                case 'next': if (currentPage < totalPages) currentPage++; break; case 'last': currentPage = totalPages; break;
                case Number.isInteger(action): currentPage = action; break;
            } renderTable();
        }
        function updatePaginationControls() { /* ... (código de updatePaginationControls que ya tienes) ... */
            const startIndex = (currentPage - 1) * currentRowsPerPage;
            const endIndex = Math.min(startIndex + currentRowsPerPage, currentDisplayedReports.length);
            paginationInfoEl.innerHTML = `Mostrando ${currentDisplayedReports.length > 0 ? startIndex + 1 : 0} a ${endIndex} de ${currentDisplayedReports.length} resultados`;
            firstPageBtnEl.disabled = currentPage === 1; prevPageBtnEl.disabled = currentPage === 1;
            nextPageBtnEl.disabled = currentPage === totalPages || totalPages <= 1; lastPageBtnEl.disabled = currentPage === totalPages || totalPages <= 1;
            prevPageMobileBtnEl.disabled = currentPage === 1; nextPageMobileBtnEl.disabled = currentPage === totalPages || totalPages <= 1;
            pageNumbersDivEl.innerHTML = ''; const maxPagesToShow = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxPagesToShow / 2));
            let endPageNum = Math.min(totalPages, startPage + maxPagesToShow - 1);
            if (endPageNum - startPage + 1 < maxPagesToShow && totalPages >= maxPagesToShow) { startPage = Math.max(1, endPageNum - maxPagesToShow + 1); }
            for (let i = startPage; i <= endPageNum; i++) {
                if (i > 0) {
                    const pageBtn = document.createElement('button');
                    pageBtn.className = `relative inline-flex items-center px-4 py-2 border text-sm font-medium ${i === currentPage ? 'bg-blue-50 border-blue-500 text-blue-600' : 'bg-white border-gray-300 text-gray-500 hover:bg-gray-50'}`;
                    pageBtn.textContent = i; pageBtn.onclick = () => paginate(i); pageNumbersDivEl.appendChild(pageBtn);
                }
            }
        }
        function handleRowClick(report) { /* ... (código de handleRowClick que ya tienes) ... */
            document.querySelectorAll('#reportsTableBody tr').forEach(tr => tr.classList.remove('bg-blue-200'));
            const rowEl = document.querySelector(`#reportsTableBody tr[data-report-id="${report.id}"]`);
            if (rowEl) rowEl.classList.add('bg-blue-200');
            if (report.latitud && report.longitud && managementMap) {
                managementMap.flyTo([report.latitud, report.longitud], 17);
                if (managementMapMarkers) {
                    managementMapMarkers.eachLayer(marker => {
                        if (marker.reportData && marker.reportData.id === report.id) {
                            if (managementMapMarkers.hasLayer(marker)) {
                                 managementMapMarkers.zoomToShowLayer(marker, () => { marker.openPopup(); });
                            }
                        }
                    });
                }
            }
        }

        // ----- LÓGICA DEL MAPA -----
        function initManagementMap() { /* ... (código de initManagementMap que ya tienes) ... */
            const puertoMadrynCoords = [-42.7692, -65.0392];
            managementMap = L.map('map').setView(puertoMadrynCoords, 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OpenStreetMap contributors' }).addTo(managementMap);
            managementMapMarkers = L.markerClusterGroup({
                iconCreateFunction: function(cluster) { /* ... tu iconCreateFunction ... */ 
                    const count = cluster.getChildCount(); let c = ' marker-cluster-';
                    if (count < 10) c += 'custom-small'; else if (count < 100) c += 'custom-medium'; else c += 'custom-large';
                    return L.divIcon({ html: `<div><span>${count}</span></div>`, className: 'marker-cluster' + c, iconSize: new L.Point(40, 40) });
                }
            });
            managementMap.addLayer(managementMapMarkers); addLegendToMap();
        }
        function addLegendToMap() { /* ... (código de addLegendToMap que ya tienes) ... */
            const legend = L.control({position: 'topright'});
            legend.onAdd = function (map) {
                const div = L.DomUtil.create('div', 'info legend-control'); let content = '<h4>Categorías</h4><ul>';
                for (const categoria in CATEGORY_COLORS) { if (categoria !== 'default') { content += `<li><i style="background:${CATEGORY_COLORS[categoria]}"></i> ${categoria}</li>`; } }
                content += '</ul>'; div.innerHTML = content; L.DomEvent.disableClickPropagation(div); return div;
            }; legend.addTo(managementMap);
        }
        function renderMapMarkers() { /* ... (código de renderMapMarkers que ya tienes, incluyendo el marker.on('click') con la lógica de paginación) ... */
            if (!managementMapMarkers) return; managementMapMarkers.clearLayers();
            currentDisplayedReports.forEach(report => {
                if (report.latitud && report.longitud) {
                    const color = CATEGORY_COLORS[report.categoria] || CATEGORY_COLORS['default'];
                    const markerIcon = L.divIcon({ className: 'custom-map-marker', html: `<div style="background-color:${color}; width: 20px; height: 20px;"></div>`, iconSize: [20, 20], iconAnchor: [10, 10] });
                    const marker = L.marker([report.latitud, report.longitud], { icon: markerIcon });
                    marker.reportData = report; marker.bindPopup(`<b>${report.calle1 || report.categoria}</b><br>Estado: ${report.estado}`); // CAMBIO: Usar calle1 en popup
                    marker.on('click', (e) => { /* ... tu lógica completa de clic en marcador de gestión ... */
                        const clickedReport = e.target.reportData; openReportModal(clickedReport.id);
                        let targetRow = document.querySelector(`#reportsTableBody tr[data-report-id="${clickedReport.id}"]`);
                        document.querySelectorAll('#reportsTableBody tr').forEach(tr => tr.classList.remove('bg-blue-200'));
                        if (targetRow) { targetRow.classList.add('bg-blue-200'); targetRow.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                        } else {
                            const reportIndexInDisplayed = currentDisplayedReports.findIndex(r => r.id === clickedReport.id);
                            if (reportIndexInDisplayed !== -1) {
                                const targetPage = Math.ceil((reportIndexInDisplayed + 1) / currentRowsPerPage);
                                if (targetPage !== currentPage && targetPage > 0 && targetPage <= totalPages) {
                                    currentPage = targetPage; renderTable();
                                    setTimeout(() => { /* ... resaltar y scroll ... */ 
                                        targetRow = document.querySelector(`#reportsTableBody tr[data-report-id="${clickedReport.id}"]`);
                                        if (targetRow) { targetRow.classList.add('bg-blue-200'); targetRow.scrollIntoView({ behavior: 'smooth', block: 'nearest' }); }
                                    }, 150);
                                } else if (targetPage === currentPage) { renderTable(); setTimeout(() => { /* ... resaltar y scroll ... */ 
                                        targetRow = document.querySelector(`#reportsTableBody tr[data-report-id="${clickedReport.id}"]`);
                                        if (targetRow) { targetRow.classList.add('bg-blue-200'); targetRow.scrollIntoView({ behavior: 'smooth', block: 'nearest' }); }
                                    }, 150);
                                }
                            }
                        }
                    });
                    managementMapMarkers.addLayer(marker);
                }
            });
        }

        // ***** PEGA ESTA FUNCIÓN COMPLETA EN TU SCRIPT ***** (YA ESTÁ PEGADA)
        function renderUserMapExistingReports(reportsToDisplay) {
            // ... (código que ya tienes y está bien, con logs y try-catch) ...
            console.log("--- EJECUTANDO renderUserMapExistingReports ---");
            if (!userMapExistingReportMarkers || !userMap) { console.warn("userMapExistingReportMarkers o userMap no están listos."); return; }
            if (typeof CATEGORY_COLORS === 'undefined') { console.error("CATEGORY_COLORS no está definida."); return; }
            userMapExistingReportMarkers.clearLayers();
            console.log("Renderizando en userMap. Cantidad recibida:", reportsToDisplay ? reportsToDisplay.length : 0);
            if (!reportsToDisplay || reportsToDisplay.length === 0) { console.log("No hay reportes para mostrar en userMap."); return; }
            try {
                reportsToDisplay.forEach(report => {
                    if (report && report.latitud != null && report.longitud != null && !isNaN(parseFloat(report.latitud)) && !isNaN(parseFloat(report.longitud))) {
                        const color = CATEGORY_COLORS[report.categoria] || CATEGORY_COLORS['default'];
                        const existingReportIcon = L.divIcon({ className: 'custom-map-marker', html: `<div style="background-color:${color}; width: 16px; height: 16px; opacity: 0.75; box-shadow: 0 0 2px rgba(0,0,0,0.5);"></div>`, iconSize: [16, 16], iconAnchor: [8, 8] });
                        const marker = L.marker([parseFloat(report.latitud), parseFloat(report.longitud)], { icon: existingReportIcon, opacity: 0.8 });
                        let popupContent = `<b>Categoría:</b> ${report.categoria || 'N/A'}<br>`;
                        if (report.calle1) { popupContent += `<b>Ubicación:</b> ${report.calle1}`; if (report.calle2) popupContent += ` y ${report.calle2}`; popupContent += '<br>'; }
                        popupContent += `<small>Estado: ${report.estado || 'N/A'}</small>`; marker.bindPopup(popupContent);
                        marker.on('click', () => { if (report.id) { openReportModal(report.id); } else { console.warn("Intento de abrir modal para reporte sin ID en userMap", report); } });
                        userMapExistingReportMarkers.addLayer(marker);
                    }
                });
                console.log("Fin del bucle forEach en renderUserMapExistingReports. Marcadores añadidos.");
            } catch (error) { console.error("ERROR DENTRO DEL BUCLE o lógica de renderUserMapExistingReports:", error); }
            console.log("--- FIN EJECUCIÓN renderUserMapExistingReports ---");
        }

        function initUserMap() {
            // ... (código de initUserMap simplificado que ya tienes y está bien) ...
            console.log("Inicializando userMap (solo base)..."); 
            const puertoMadrynCoords = [-42.7692, -65.0392];
            if (!userMap) { 
                userMap = L.map('userMap', {}).setView(puertoMadrynCoords, 13);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OpenStreetMap contributors' }).addTo(userMap);
                console.log("userMap base creado.");
            } else { userMap.setView(puertoMadrynCoords, 13); }
            if (!userMapExistingReportMarkers) { 
                userMapExistingReportMarkers = L.layerGroup().addTo(userMap);
            } else { userMapExistingReportMarkers.clearLayers(); if (!userMap.hasLayer(userMapExistingReportMarkers)) { userMap.addLayer(userMapExistingReportMarkers);}}
        }

        // ***** INICIO DEL BLOQUE B - NUEVAS FUNCIONES ***** (YA ESTÁN PEGADAS)
        function actualizarMarcadorYFormulario(latLng) { /* ... (código que ya tienes) ... */ 
             if (!userMap || !latLng || typeof latLng.lat === 'undefined' || typeof latLng.lng === 'undefined') { console.error("actualizarMarcadorYFormulario: userMap o latLng no válidos.", userMap, latLng); return; }
            if (selectedLocation) { userMap.removeLayer(selectedLocation); }
            try { selectedLocation = L.marker(latLng).addTo(userMap); } catch (error) { console.error("Error al crear L.marker:", error); alert("Error al colocar marcador."); return; }
            if (reportFormContainerEl) reportFormContainerEl.classList.remove('hidden');
            if (successMessageDivEl) successMessageDivEl.classList.add('hidden');
            if (window.innerWidth < 768 && reportFormContainerEl) { reportFormContainerEl.scrollIntoView({ behavior: 'smooth' }); }
        }
        function obtenerUbicacionGPSParaUserMap() { /* ... (código que ya tienes) ... */
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition( (position) => {
                    const nuevaPosicion = L.latLng(position.coords.latitude, position.coords.longitude);
                    if (userMap) { userMap.flyTo(nuevaPosicion, 17); actualizarMarcadorYFormulario(nuevaPosicion); }
                }, (error) => { /* ... manejo de error de GPS ... */ 
                    console.warn("Error al obtener ubicación GPS:", error.message, "Código:", error.code);
                    let alertMessage = "No se pudo obtener tu ubicación GPS. ";
                    if (error.code === 1) alertMessage += "Has denegado el permiso."; else if (error.code === 2) alertMessage += "Ubicación no disponible."; else if (error.code === 3) alertMessage += "Timeout.";
                    alert(alertMessage + " Selecciona manualmente.");
                }, { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 });
            } else { alert("Geolocalización no soportada."); }
        }

        // ----- LÓGICA DEL MODAL -----
        function openReportModal(reportId) {
            const report = allReports.find(r => r.id === reportId);
            if (!report) return;
            currentReportIdForModal = reportId;

            let modalHeaderText = `Reporte #${report.id}`;
            if (report.calle1) {
                modalHeaderText = `${report.calle1.substring(0, 25)}${report.calle1.length > 25 ? '...' : ''} - #${report.id}`;
            } else if (report.categoria) {
                modalHeaderText = `${report.categoria} - #${report.id}`;
            }
            if (modalTitleEl) modalTitleEl.textContent = modalHeaderText;
            if(modalCalle1PEl) modalCalle1PEl.textContent = report.calle1 || 'No especificada'; if(modalCalle2PEl) modalCalle2PEl.textContent = report.calle2 || 'N/A';
            if(modalCategoriaPEl) modalCategoriaPEl.textContent = report.categoria || 'N/A';
            if(modalStatusPEl) modalStatusPEl.innerHTML = `<span class="status-badge ${getStatusClass(report.estado)}">${report.estado || 'N/A'}</span>`;
            if(modalDatePEl) modalDatePEl.textContent = report.fechaCreacion || 'N/A'; if(modalDateModifiedPEl) modalDateModifiedPEl.textContent = report.fechaUltimaModificacion || 'N/A';
            if(modalLocationPEl) modalLocationPEl.textContent = (report.latitud != null && report.longitud != null) ? `${Number(report.latitud).toFixed(4)}, ${Number(report.longitud).toFixed(4)}` : 'N/A';
            if(modalDescriptionPEl) modalDescriptionPEl.textContent = report.descripcion || 'Sin descripción.';
            if (report.imagenURL && modalImageEl && modalImageContainerEl) { modalImageEl.src = report.imagenURL; modalImageContainerEl.classList.remove('hidden');
            } else if (modalImageContainerEl && modalImageEl) { modalImageContainerEl.classList.add('hidden'); modalImageEl.src = ''; }
            if(markInProgressBtnEl) markInProgressBtnEl.classList.toggle('hidden', report.estado === 'En proceso' || report.estado === 'Solucionado');
            if(markSolvedBtnEl) markSolvedBtnEl.classList.toggle('hidden', report.estado === 'Solucionado');
            if(reportModalEl) reportModalEl.classList.remove('hidden');
        }
        function closeModal() { /* ... (código de closeModal que ya tienes) ... */
            if (reportModalEl) { reportModalEl.classList.add('hidden');} currentReportIdForModal = null;
        }
        async function updateReportStatusOnModal(newStatus) { /* ... (código que ya tienes) ... */
            if (currentReportIdForModal) { await updateReportStatus(currentReportIdForModal, newStatus); } closeModal();
        }
        async function updateReportStatus(reportId, newStatus) { /* ... (código que ya tienes y funciona) ... */
            console.log(`Actualizando reporte ${reportId} a estado: ${newStatus}`);
            const { doc, updateDoc, serverTimestamp } = window.firebaseFirestore; const reportRef = doc(window.db, "reclamos", reportId);
            try { await updateDoc(reportRef, { estado: newStatus, fechaUltimaModificacion: serverTimestamp() });
            } catch (error) { console.error("Error al actualizar estado:", error); alert("Error al actualizar estado."); }
        }

        // ----- LÓGICA DE ESTADÍSTICAS -----
        function updateStatistics() {
            if (allReports.length === 0) {
                todayReportsSpanEl.textContent = 0;
                monthReportsSpanEl.textContent = 0;
                solvedPercentageSpanEl.textContent = '0%';
                urgentReportsSpanEl.textContent = '0%';
                return;
            }

            const today = new Date();
            let todayCount = 0;
            let monthCount = 0;
            let solvedCount = 0;
            let totalDañados = 0;
            let urgentesNoSolucionados = 0;

            allReports.forEach(report => {
                // Usamos isSameDay para comparar fechas como objetos Date
                if (isSameDay(report.fechaCreacion, today)) todayCount++;

                const reportDate = report.fechaCreacion || new Date(0); // Evitar null

                if (
                    reportDate.getMonth() === today.getMonth() &&
                    reportDate.getFullYear() === today.getFullYear()
                ) {
                    monthCount++;
                }

                if (report.estado === 'Solucionado') solvedCount++;

                if (report.categoria === 'Dañado') {
                    totalDañados++;
                    if (report.estado !== 'Solucionado') urgentesNoSolucionados++;
                }
            });

            todayReportsSpanEl.textContent = todayCount;
            monthReportsSpanEl.textContent = monthCount;

            const percentageSolved = allReports.length > 0
                ? Math.round((solvedCount / allReports.length) * 100)
                : 0;

            solvedPercentageSpanEl.textContent = `${percentageSolved}%`;

            urgentReportsSpanEl.textContent = totalDañados > 0
                ? `${Math.round((urgentesNoSolucionados / totalDañados) * 100)}%`
                : '0%';
        }

        // ----- FUNCIONES UTILITARIAS -----
        function formatDate(date) {
            if (!(date instanceof Date)) return 'Fecha no disponible';
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }
        function parseDate(dateString) {
            if (!dateString || dateString === 'Fecha no disponible') return new Date(0); // Fecha muy antigua
            const [day, month, year] = dateString.split('/');
            return new Date(year, month - 1, day);
        }
        function getStatusClass(status) {
            switch (status) {
                case 'Iniciado':
                    return 'bg-blue-200 text-blue-900';
                case 'En proceso':
                    return 'bg-yellow-200 text-yellow-900';
                case 'Solucionado':
                    return 'bg-green-200 text-green-900';
                default:
                    return 'bg-gray-200 text-gray-900';
            }
        }
        function highlightTableRow(reportId) { /* ... */ }

        // ----- FUNCIÓN AUXILIAR PARA COMPARAR FECHAS -----
        function isSameDay(date1, date2) {
            return (
                date1 &&
                date2 &&
                date1.getFullYear() === date2.getFullYear() &&
                date1.getMonth() === date2.getMonth() &&
                date1.getDate() === date2.getDate()
            );
}

    </script>
    
    <!-- ================================================== -->
    <!-- ===== INICIO: REGISTRO DEL SERVICE WORKER ====== -->
    <!-- ================================================== -->
    <!-- Service Worker Registration con autoactualización -->
    <script>
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('./service-worker.js')
                .then(registration => {
                    console.log('Service Worker registrado:', registration.scope);

                    // Forzar actualización automática
                    if (registration.waiting) {
                        sendSkipWaitingMessage(registration.waiting);
                    }

                    registration.addEventListener('updatefound', () => {
                        const installingWorker = registration.installing;
                        if (installingWorker && installingWorker.state === 'installed') {
                            sendSkipWaitingMessage(installingWorker);
                        }
                    });

                    // Escuchar cambios de controlador para recargar página
                    navigator.serviceWorker.addEventListener('controllerchange', () => {
                        window.location.reload();
                    });
                })
                .catch(error => {
                    console.error('Error registrando Service Worker:', error);
                });
        });
    }

    function sendSkipWaitingMessage(worker) {
        worker.postMessage({ type: 'SKIP_WAITING' });
    }
    </script>
    <!-- ================================================ -->
    <!-- ===== FIN: REGISTRO DEL SERVICE WORKER ======= -->
    <!-- ================================================ -->
     
</body>
</html>